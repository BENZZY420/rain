local function RainbowGuns()
    local player = game.Players.LocalPlayer
    local gunsFolder = workspace:FindFirstChild("GUNS")
    if not gunsFolder then
        warn("GUNS folder not found in workspace!")
        return {
            Enable = function() end,
            Disable = function() end
        }
    end

    local validGunNames = {}
    for _, gun in ipairs(gunsFolder:GetChildren()) do
        validGunNames[gun.Name] = true
    end

    local activeRainbowThreads = {}
    local originalProperties = {}

    local running = false

    local function startRainbow(tool)
        if not running or activeRainbowThreads[tool] then return end

        local parts = {}
        originalProperties[tool] = {}
        for _, part in ipairs(tool:GetDescendants()) do
            if part:IsA("BasePart") then
                table.insert(parts, part)
                originalProperties[tool][part] = {
                    Color = part.Color,
                    Material = part.Material,
                    Transparency = part.Transparency
                }
            end
        end

        if #parts > 0 then
            local stopped = false
            activeRainbowThreads[tool] = function()
                stopped = true
                -- Reset parts
                for _, part in ipairs(parts) do
                    local orig = originalProperties[tool][part]
                    if orig then
                        part.Color = orig.Color
                        part.Material = orig.Material
                        part.Transparency = orig.Transparency
                    end
                end
                activeRainbowThreads[tool] = nil
            end

            task.spawn(function()
                for _, part in ipairs(parts) do
                    part.Material = Enum.Material.Glass
                    part.Transparency = 0.3
                end
                while not stopped and (tool.Parent == player.Backpack or tool.Parent == player.Character) do
                    local now = tick()
                    local step = math.floor(now / 1)
                    local hue = (step % 12) / 12
                    local color = Color3.fromHSV(hue, 1, 1)
                    for _, part in ipairs(parts) do
                        part.Color = color
                    end
                    task.wait(0.05)
                end
            end)
        end
    end

    local function stopAllRainbows()
        for tool, stopper in pairs(activeRainbowThreads) do
            stopper()
        end
        activeRainbowThreads = {}
    end

    local function applyToInventoryAndEquipped()
        for _, tool in ipairs(player.Backpack:GetChildren()) do
            if tool:IsA("Tool") and validGunNames[tool.Name] then
                startRainbow(tool)
            end
        end
        if player.Character then
            for _, tool in ipairs(player.Character:GetChildren()) do
                if tool:IsA("Tool") and validGunNames[tool.Name] then
                    startRainbow(tool)
                end
            end
        end
    end

    local function onToolAdded(tool)
        if tool:IsA("Tool") and validGunNames[tool.Name] then
            startRainbow(tool)
        end
    end

    local function connectCharacter(char)
        char.ChildAdded:Connect(onToolAdded)
    end

    return {
        Enable = function()
            if running then return end
            running = true
            applyToInventoryAndEquipped()
            player.Backpack.ChildAdded:Connect(onToolAdded)
            player.CharacterAdded:Connect(connectCharacter)
            if player.Character then
                connectCharacter(player.Character)
            end
        end,
        Disable = function()
            running = false
            stopAllRainbows()
        end
    }
end

